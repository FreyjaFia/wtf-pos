<div class="flex h-full gap-4">
  <div class="flex flex-1 flex-col overflow-hidden">
    @if (editMode() && isLoadingOrder()) {
      <div class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg"></span>
      </div>
    }

    @if (!editMode() || !isLoadingOrder()) {
      <!-- Header: Title on Left, Tools on Right -->
      <div class="mb-6 flex shrink-0 items-center justify-between px-0 py-2">
        <!-- Left: Title -->
        <h2 class="text-2xl font-bold text-gray-900">Products</h2>

        <!-- Right: Search and Filter (Grouped as Unified Toolbar) -->
        <div class="flex items-center gap-3">
          <!-- Search Input (Ghost Style, Fixed Width) -->
          <label
            class="flex w-72 items-center gap-2 rounded-lg bg-gray-50 px-3 py-2 transition-colors focus-within:bg-white focus-within:ring-2 focus-within:ring-gray-200"
            [class.pointer-events-none]="isCompleted()"
            [class.opacity-50]="isCompleted()"
          >
            <app-icon
              name="icon-search"
              [class]="'h-5 w-5 shrink-0 opacity-40'"
              [fill]="'currentColor'"
            />
            <input
              type="search"
              class="grow bg-transparent text-sm placeholder-gray-500 focus:caret-[#047857] focus:outline-none"
              placeholder="Search by product name"
              [formControl]="filterForm.controls.searchTerm"
            />
          </label>

          <!-- Category Filter Dropdown (Right-Aligned) -->
          <div
            class="dropdown dropdown-end"
            [class.pointer-events-none]="isCompleted()"
            [class.opacity-50]="isCompleted()"
          >
            <app-filter-dropdown
              [title]="'Category'"
              [icon]="'icon-category'"
              [options]="filterOptions()"
              [selectedIds]="selectedProductCategories()"
              (filterChange)="onProductCategoryFilterChange($event)"
              (filterReset)="onProductCategoryFilterReset()"
            />
          </div>
        </div>
      </div>

      <!-- Scrollable product grid -->
      @if (isLoading()) {
        <div class="flex justify-center py-8">
          <span class="loading loading-spinner loading-lg"></span>
        </div>
      }

      @if (!isLoading()) {
        @if (products().length === 0) {
          <div class="flex flex-1 flex-col items-center justify-center text-center opacity-60">
            <app-icon name="icon-search" [class]="'mb-3 h-12 w-12'" />
            <div class="text-sm font-medium">No products found</div>
            <div class="text-xs">Try adjusting your filters or add a new product</div>
          </div>
        } @else {
          <div class="flex-1 overflow-y-auto pb-4">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
              @for (p of products(); track p.id) {
                <div
                  class="card flex h-60 flex-col overflow-hidden rounded-xl bg-white shadow-lg transition-all duration-200"
                  [class.cursor-pointer]="!isCompleted()"
                  [class.cursor-default]="isCompleted()"
                  [class.opacity-50]="isCompleted()"
                  [class.hover:shadow-xl]="!isCompleted()"
                  [class.hover:-translate-y-0.5]="!isCompleted()"
                  role="button"
                  tabindex="0"
                  (click)="!isCompleted() && addToCart(p)"
                  (keydown.enter)="!isCompleted() && addToCart(p)"
                  (keydown.space)="!isCompleted() && addToCart(p)"
                >
                  <figure class="flex h-32 shrink-0 items-center justify-center">
                    <img [src]="p.imageUrl" [alt]="p.name" class="h-24 w-24 object-contain" />
                  </figure>
                  <div class="card-body flex flex-1 flex-col justify-between p-4">
                    <h2 class="card-title text-base font-semibold text-gray-800">{{ p.name }}</h2>
                    <div class="card-actions mt-auto items-center justify-between">
                      <div class="text-lg font-bold text-black">
                        <span class="text-base opacity-70">₱</span>{{ p.price | number: '1.2-2' }}
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      }
    }
  </div>

  <aside
    class="flex w-80 shrink-0 flex-col overflow-hidden rounded-lg border-l-2 border-gray-200 bg-white shadow-[-8px_0_24px_rgba(0,0,0,0.1)]"
  >
    <div class="shrink-0 border-b border-gray-100 p-4">
      <div class="flex items-center justify-between">
        <div>
          @if (editMode()) {
            <h3 class="text-lg font-semibold">Edit Order</h3>
            @if (currentOrder()) {
              <div class="text-sm opacity-70">#{{ currentOrder()!.orderNumber }}</div>
            }
          } @else {
            <h3 class="text-lg font-semibold">New Order</h3>
          }
          <div class="text-sm opacity-70">{{ itemCount() }} items</div>
        </div>
        <button
          class="btn btn-ghost btn-sm text-error"
          (click)="clearAll()"
          [class.hidden]="isCompleted()"
        >
          Clear
        </button>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4">
      @if (cart().length === 0) {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <app-icon name="icon-product" [class]="'mb-4 h-20 w-20 opacity-20'" />
          <div class="text-base font-semibold text-gray-700">Your cart is empty</div>
          <div class="text-sm text-gray-500">Add items to get started</div>
        </div>
      }

      @for (c of cart(); track c.productId; let last = $last) {
        <div class="mb-3 flex items-center gap-3 rounded-lg bg-gray-50 p-4 shadow-sm">
          <div class="flex h-16 w-16 shrink-0 items-center justify-center">
            <img [src]="c.imageUrl" [alt]="c.name" class="h-12 w-12 object-contain" />
          </div>
          <div class="flex min-w-0 flex-1 flex-col justify-between gap-2">
            <div class="flex items-start justify-between gap-4 sm:gap-6">
              <div class="min-w-0 flex-1 text-sm font-semibold text-gray-900">{{ c.name }}</div>
              <div class="shrink-0 text-sm text-gray-500">
                <span class="text-xs opacity-60">₱</span>{{ c.price | number: '1.2-2' }}
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                @if (!isCompleted()) {
                  <button
                    class="btn btn-circle btn-sm bg-gray-200 transition-colors hover:bg-gray-300"
                    (click)="decrement(c.productId)"
                    aria-label="Decrease quantity"
                  >
                    <span class="text-base leading-none font-bold">−</span>
                  </button>
                }
                <div class="w-6 text-center text-sm font-medium">{{ c.qty }}</div>
                @if (!isCompleted()) {
                  <button
                    class="btn btn-circle btn-sm bg-gray-200 transition-colors hover:bg-gray-300"
                    (click)="increment(c.productId)"
                    aria-label="Increase quantity"
                  >
                    <span class="text-base leading-none font-bold">+</span>
                  </button>
                }
              </div>
              <div class="text-base font-bold text-gray-900">
                <span class="text-xs opacity-70">₱</span>{{ c.qty * c.price | number: '1.2-2' }}
              </div>
            </div>
          </div>
        </div>
      }
    </div>

    <div
      class="sticky bottom-0 shrink-0 border-t border-gray-200 bg-white p-5 shadow-[0_-8px_24px_rgba(0,0,0,0.1)]"
    >
      <div class="mb-4 flex items-center justify-between">
        <div class="text-sm font-semibold tracking-wide text-gray-500 uppercase">Total</div>
        <div class="text-2xl font-bold text-black">
          <span class="text-lg opacity-70">₱</span>{{ totalPrice() | number: '1.2-2' }}
        </div>
      </div>

      <div class="flex flex-col gap-2">
        @if (isCompleted()) {
          <button class="btn btn-neutral w-full" (click)="cancel()">
            <app-icon name="icon-back" [class]="'h-5 w-5'" />
            Back
          </button>
        } @else {
          <div class="flex gap-2">
            @if (editMode()) {
              <button class="btn btn-outline flex-1 rounded-lg" (click)="cancel()">Cancel</button>
            }
            <button
              class="btn btn-outline pointer-events-auto flex-1 rounded-lg transition-all disabled:opacity-50"
              [style.cursor]="cart().length === 0 ? 'not-allowed' : 'pointer'"
              (click)="onOrderSaved()"
              [disabled]="cart().length === 0"
            >
              Save
            </button>
          </div>
          <button
            class="btn btn-lg pointer-events-auto w-full rounded-lg border-0 bg-[#047857] text-base font-semibold text-white shadow-lg transition-all hover:bg-[#065f46] hover:shadow-xl disabled:bg-gray-200 disabled:text-gray-400 disabled:opacity-100 disabled:shadow-none"
            [style.cursor]="cart().length === 0 ? 'not-allowed' : 'pointer'"
            (click)="checkout()"
            [disabled]="cart().length === 0"
          >
            Checkout
          </button>
        }
      </div>
    </div>

    <app-checkout-modal
      [cartItems]="cart()"
      [totalPrice]="totalPrice()"
      (orderConfirmed)="onOrderConfirmed($event)"
    />
  </aside>
</div>
